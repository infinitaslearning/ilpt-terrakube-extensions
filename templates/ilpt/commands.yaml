commands:
  - runtime: "GROOVY"
    priority: 100
    before: true
    script: |
          import Opa

          new Opa().loadTool(
            "$workingDirectory",
            "$bashToolsDirectory",
            "1.6.0")
          "Opa Download Completed..."
  - runtime: "BASH"
    priority: 200
    after: true
    script: |
          cd $workingDirectory;
          terraform show -json terraformLibrary.tfPlan > tfplan.json;
          echo "Checkint Open Policy Agent Policy";
          opaChecklocation=$(opa exec --decision terraform/analysis/notallowedlocationsmsg --bundle .terrakube/toolsRepository/policy/ tfplan.json | jq '.result[0].result');
          opaChecktags=$(opa exec --decision terraform/analysis/checktags --bundle .terrakube/toolsRepository/policy/ tfplan.json | jq '.result[0].result');

          if [ "$opaChecklocation" == "{}" ]; then
            echo "Changes are okay for location policy"
          else
            echo "The location policy found the following issues with this change : "
            echo $opaChecklocation
          fi
          if [ "$opaChecktags" == "{}" ]; then
            echo "Changes are okay for the Tags policy"
          else
            echo "The tags policy found the following issues with this change : "
            echo $opaChecktags
          fi
          if [ "$opaChecklocation" == "{}" ] && [ "$opaChecktags" == "{}" ]; then
            echo "Policies are valid"
            exit 0
          else
            echo "Policies are invalid"
            exit 1
          fi